# Cloud Run ソースから直接デプロイ（最も簡単）

## 概要

`line-register-app`と同じように、Cloud Run の「ソースから直接デプロイ」機能を使います。
**cloudbuild.yaml は不要です。** Cloud Run が自動的に Dockerfile を見つけてビルドします。

## 必要な準備

✅ GitHub リポジトリが準備されている（`okada1125/cp-salon-lumina`）
✅ Dockerfile が存在する
✅ 環境変数の情報がある

## 手順

### ステップ 1: Cloud Run を開く

1. **Google Cloud Console**にアクセス
   https://console.cloud.google.com/run

2. **「サービスを作成」** をクリック

### ステップ 2: デプロイ方法を選択

**「ソースから直接デプロイ」** タブをクリック

### ステップ 3: リポジトリを接続

1. **「リポジトリを接続」** をクリック
2. 初回の場合：
   - **「リポジトリの接続」** をクリック
   - GitHub アカウントで認証
   - 必要に応じて権限を許可
3. リポジトリを選択：
   - `okada1125/cp-salon-lumina` を選択
4. ブランチを選択：
   - `main` を選択
5. **「次へ」** をクリック

### ステップ 4: ビルド設定

**ビルドタイプ**: Dockerfile を選択（デフォルト）

**場所**: Dockerfile（デフォルト）

**このままで OK！**

### ステップ 5: サービス設定

**リージョン**

- リージョン: `asia-northeast1` を選択

**認証**

- ✅ **未認証の呼び出しを許可** にチェックを入れる

**環境変数**（重要！）
「環境変数を追加」をクリックして、以下を追加：

| 名前                        | 値                                                                    |
| --------------------------- | --------------------------------------------------------------------- |
| `DATABASE_URL`              | `mysql://root:KvRPDbd>\m.L}701@35.221.114.163:3306/line_contact_form` |
| `LINE_CHANNEL_SECRET`       | `9239b0c9a368bbc48b4c6601201a00aa`                                    |
| `LIFF_ID`                   | `2008317301-ANXP8KZG`                                                 |
| `LINE_CHANNEL_ACCESS_TOKEN` | `9239b0c9a368bbc48b4c6601201a00aa`                                    |

**サービス名**

- `line-contact-form`

**その他の設定**

- デフォルトのままで OK

### ステップ 6: デプロイ実行

**「作成」** をクリック

### ステップ 7: 完了を待つ

1. **ビルドの進行を確認**

   - 「ビルドの進行状況」が表示される
   - 通常 5-15 分程度で完了

2. **サービスの確認**
   - ビルドが完了すると、Cloud Run サービスが作成される
   - URL が表示される

## 完了！

これで `line-register-app` と同じ設定が完了しました！

✅ デプロイタイプが「ソース」で表示される  
✅ GitHub に push すると自動的に再デプロイされる  
✅ Artifact Registry は自動的に作成される  
✅ Cloud Build トリガーも自動的に作成される

## 今後の運用

### コードを更新する場合

```bash
git add .
git commit -m "Update something"
git push origin main

# 自動的に再デプロイされる
```

### デプロイ履歴の確認

- Cloud Run → サービス → `line-contact-form` → **「リビジョン」** タブ
- 各デプロイの履歴とトラフィック設定を確認できる

### 環境変数を変更する場合

- Cloud Run → サービス → `line-contact-form` → **「編集」**
- 環境変数を追加/変更
- **「デプロイ」** をクリック

### ログの確認

- Cloud Run → サービス → `line-contact-form` → **「ログ」** タブ
- アプリケーションのログをリアルタイムで確認できる

## トラブルシューティング

### ビルドが失敗する場合

**エラー**: Dockerfile が存在しない

**解決方法**:

- プロジェクトルートに Dockerfile が存在するか確認
- Dockerfile の内容を確認

**エラー**: Prisma の生成エラー

**解決方法**:

- Dockerfile で Prisma クライアントが正しく生成されているか確認
- postinstall スクリプトが package.json に追加されているか確認

### サービスが作成されない場合

**確認事項**:

- ビルドが成功しているか（エラーがないか）
- 環境変数が正しく設定されているか
- リージョンが正しいか（asia-northeast1）

### URL にアクセスできない場合

**確認事項**:

- 「未認証の呼び出しを許可」にチェックが入っているか
- サービスのステータスが「Ready」になっているか
- エラーログを確認（Cloud Run → ログ）

## 完成！

Cloud Run の「ソースから直接デプロイ」を使うことで、最も簡単にデプロイできます。

- ✅ cloudbuild.yaml は不要
- ✅ 手動で Artifact Registry を作成する必要がない
- ✅ Cloud Build トリガーも自動的に作成される
- ✅ `line-register-app`と同じ「ソース」タイプとして表示される
